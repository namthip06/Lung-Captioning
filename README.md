# Lung-Captioning: Advanced Medical Vision-Language Model

## Project Overview

โปรเจกต์นี้คือการพัฒนาและปรับแต่ง Vision-Language Model เพื่อทำหน้าที่เป็นผู้ช่วยรังสีแพทย์ โดยมีความสามารถแบบ Multi-task คือการระบุหมวดหมู่ของโรคจากภาพเอกซเรย์ปอด และการสร้างคำอธิบายผลการตรวจในรูปแบบภาษาทางการแพทย์ที่มีความแม่นยำสูง

ปัญหาหลักที่โปรเจกต์นี้แก้ไขคือการที่รังสีแพทย์ต้องใช้เวลาสูงในการเขียนรายงาน และชุดข้อมูลภาพการแพทย์มักมีความไม่สมดุล ซึ่งทำให้โมเดลทั่วไปมักทำนายผิดพลาดในโรคที่พบน้อย โปรเจกต์นี้จึงมุ่งเน้นการแก้ปัญหาด้วยการทำ Advanced Data Augmentation และ Synthetic Data Generation เพื่อสร้างโมเดลที่ใช้งานได้จริง

## Core Functionality

* วิเคราะห์ภาพเอกซเรย์ปอดและระบุความผิดปกติ เช่น Inflammatory Pneumonia หรือ Mediastinal Changes
* สร้างรายงานผลเชิงเทคนิคที่ระบุถึงพยาธิสภาพและความเห็นของแพทย์
* ระบบเตรียมข้อมูลที่สามารถรักษาสมดุลของแต่ละกลุ่มโรคอัตโนมัติด้วยเทคนิค Image Augmentation และการใช้ Gemini API สร้างข้อความสังเคราะห์เพื่อเพิ่มความหลากหลายของภาษา

## Tech Stack & Tools

### Artificial Intelligence & Machine Learning

* Model Architecture: Qwen2.5-VL-3B-Instruct
* Fine-tuning Framework: Unsloth ซึ่งช่วยให้การฝึกฝนโมเดลเร็วขึ้นและลดการใช้หน่วยความจำกราฟิกผ่านเทคนิค 4-bit Quantization
* Parameter-Efficient Fine-Tuning: ใช้ LoRA และ rsLoRA เพื่อปรับแต่งเฉพาะส่วนการวิเคราะห์ภาพและส่วนประสานข้อมูลเพื่อป้องกันปัญหาการสูญเสียความสามารถเดิมของโมเดล

### Data Engineering & Augmentation

* Gemini API: ใช้สร้างโครงสร้างรายงานรังสีวิทยาและข้อความนำเข้าจากผู้ใช้จำนวนมากเพื่อสร้างชุดข้อมูลสังเคราะห์
* Pillow และ NumPy: ใช้ประมวลผลภาพขั้นสูง เช่น การเพิ่มสัญญาณรบกวน การหมุน การปรับขนาด และการปรับความคมชัดของภาพ
* Hugging Face Datasets: ใช้จัดการและจัดเก็บชุดข้อมูลขนาดใหญ่เพื่อประสิทธิภาพในการประมวลผล

## Performance Results

ตารางเปรียบเทียบประสิทธิภาพของโมเดลก่อนและหลังการปรับแต่งด้วยเทคนิคที่พัฒนาขึ้น โดยใช้ค่า Macro-F1 Score เป็นตัวชี้วัดหลักสำหรับการจำแนกโรค

| Metric | Base Model (Pre-trained) | Fine-tuned Model (This Project) |
| --- | --- | --- |
| Macro-F1 Score | 0.17 | 0.82 |
| ROUGE-L (Captioning) | 0.12 | 0.45 |
| Classification Accuracy | 24% | 85% |

หมายเหตุ: ค่า Macro-F1 Score ที่เพิ่มขึ้นอย่างมากแสดงให้เห็นว่าโมเดลสามารถจดจำโรคกลุ่มที่พบน้อยได้ดีขึ้น ไม่เพียงแต่ทายเฉพาะกลุ่มที่เป็นปกติเท่านั้น

## Key Skills Demonstrated

* การปรับแต่งโมเดลประมวลผลภาพและภาษาขั้นสูง โดยเลือกปรับแต่งเฉพาะเลเยอร์สำคัญเพื่อประสิทธิภาพสูงสุด
* การจัดการปัญหาข้อมูลไม่สมดุลด้วยการออกแบบระบบ Dynamic Balancing
* การเขียน Custom Callbacks ในกระบวนการฝึกฝนโมเดลเพื่อตรวจสอบคุณภาพของข้อความและป้องกันการบันทึกโมเดลที่มีประสิทธิภาพต่ำกว่าเกณฑ์
* การประยุกต์ใช้โมเดลภาษาขนาดใหญ่ในการสร้างข้อมูลสังเคราะห์เพื่อแก้ปัญหาการขาดแคลนข้อมูลทางการแพทย์

## Challenges & Solutions

### โมเดลตอบเหหมือนกันหมด

ในช่วงแรกโมเดลมีแนวโน้มที่จะตอบว่าเป็นปกติในทุกภาพเนื่องจากเป็นกลุ่มข้อมูลที่ใหญ่ที่สุด วิธีแก้ไขคือการใช้ Macro-F1 Score เป็นเกณฑ์ตัดสินหลักแทนความแม่นยำรวม และใช้ rsLoRA ร่วมกับการกำหนดค่า Dropout เพื่อเพิ่มความทนทานของโมเดล

### ข้อจำกัดของทรัพยากรระบบ

การฝึกฝนโมเดลขนาดใหญ่บนหน่วยความจำกราฟิกที่จำกัดทำได้ยาก จึงมีการใช้เทคนิค Quantization ร่วมกับการสะสมค่าความชันเพื่อจำลองขนาดกลุ่มข้อมูลที่ใหญ่ขึ้นโดยไม่ใช้หน่วยความจำเกินขีดจำกัด

## Article & Documentation

สามารถอ่านรายละเอียดเชิงลึกเกี่ยวกับขั้นตอนการพัฒนา เทคนิคการคุมคุณภาพของข้อมูล และวิธีการตั้งค่าโมเดลได้ที่บทความ Medium:
[สร้าง LoRA ให้โมเดล AI เพื่ออธิบายภาพเอกซเรย์ปอดด้วย Qwen2.5-VL-3B](https://medium.com/@gunosonka/%E0%B8%AA%E0%B8%A3%E0%B9%89%E0%B8%B2%E0%B8%87-lora-%E0%B9%83%E0%B8%AB%E0%B9%89%E0%B9%82%E0%B8%A1%E0%B9%80%E0%B8%94%E0%B8%A5-ai-%E0%B9%80%E0%B8%9E%E0%B8%B7%E0%B9%88%E0%B8%AD%E0%B8%AD%E0%B8%98%E0%B8%B4%E0%B8%9A%E0%B8%B2%E0%B8%A2%E0%B8%A0%E0%B8%B2%E0%B8%9E%E0%B9%80%E0%B8%AD%E0%B8%81%E0%B8%8B%E0%B9%80%E0%B8%A3%E0%B8%A2%E0%B9%8C%E0%B8%9B%E0%B8%AD%E0%B8%94%E0%B8%94%E0%B9%89%E0%B8%A7%E0%B8%A2-qwen2-5-vl-3b-3bdc63e4d240)

## Directory Structure

```text
└── namthip06-lung-captioning/
    ├── prepare_data/            # สคริปต์สำหรับสร้างข้อมูลสังเคราะห์
    │   ├── disease_template.py  # โครงสร้างความสัมพันธ์ของโรคและรายงาน
    │   └── call_api_for_disease.py
    ├── prepare_data.ipynb       # ระบบประมวลผลและเพิ่มขยายภาพ
    ├── qwen_optimize.ipynb      # สคริปต์หลักในการปรับแต่งและประเมินผลโมเดล
    ├── requirements.txt         # รายการไลบรารีที่จำเป็น
    └── README.md

```
